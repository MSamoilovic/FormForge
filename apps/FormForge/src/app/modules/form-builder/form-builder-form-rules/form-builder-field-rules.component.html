<div [formGroup]="parentForm()" class="rules-editor-container">
  <h4>Rules</h4>
  <div formArrayName="rules">
    @for (ruleGroup of rulesFormArray().controls; let i = $index; track i) {
      <mat-card class="rule-card" [formGroupName]="i">
        <mat-card-header class="rule-header">
          <mat-card-title>Rule #{{ i + 1 }}</mat-card-title>
          <button
            mat-icon-button
            color="warn"
            (click)="removeRule(i)"
            matTooltip="Delete this rule"
          >
            <mat-icon>delete_forever</mat-icon>
          </button>
        </mat-card-header>

        <mat-card-content>
          <!-- Sekcija za USLOVE (CONDITIONS) -->
          <div class="conditions-section" formArrayName="conditions">
            <div class="section-header">
              <h6>IF...</h6>
              <button
                mat-stroked-button
                color="primary"
                (click)="addCondition(i)"
              >
                <mat-icon>add</mat-icon>
                AND
              </button>
            </div>
            @for (conditionGroup of $any(ruleGroup.get('conditions')).controls; let
              c_idx = $index; track c_idx) {
              <div class="condition-row" [formGroupName]="c_idx">
                <mat-form-field appearance="outline" class="rule-field">
                  <mat-label>Field</mat-label>
                  <mat-select formControlName="fieldId">
                    @for (field of allFormFields(); track field.id) {
                      <mat-option [value]="field.id">{{ field.label }}</mat-option>
                    }
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline" class="rule-operator">
                  <mat-label>Operator</mat-label>
                  <mat-select formControlName="operator">
                    @for (op of conditionOperators; track op) {
                      <mat-option [value]="op">{{ op }}</mat-option>
                    }
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline" class="rule-field">
                  <mat-label>Value</mat-label>
                  <input matInput formControlName="value" />
                </mat-form-field>

                <button
                  mat-icon-button
                  (click)="removeCondition(i, c_idx)"
                  matTooltip="Remove condition"
                >
                  <mat-icon>remove_circle_outline</mat-icon>
                </button>
              </div>
            }
          </div>

          <mat-divider></mat-divider>

          <!-- Sekcija za AKCIJE (ACTIONS) -->
          <div class="actions-section" formArrayName="actions">
            <div class="section-header">
              <h6>THEN...</h6>
              <button
                mat-stroked-button
                color="primary"
                (click)="addAction(i)"
              >
                <mat-icon>add</mat-icon>
                Action
              </button>
            </div>
            @for (actionGroup of $any(ruleGroup.get('actions')).controls; let
              a_idx = $index; track a_idx) {
              <div class="action-row" [formGroupName]="a_idx">
                <mat-form-field appearance="outline" class="rule-action-type">
                  <mat-label>Action</mat-label>
                  <mat-select formControlName="type">
                    @for (action of actionTypes; track action) {
                      <mat-option [value]="action">{{ action }}</mat-option>
                    }
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline" class="rule-field">
                  <mat-label>Target Field</mat-label>
                  <mat-select formControlName="targetFieldId">
                    @for (field of allFormFields(); track field.id) {
                      <mat-option [value]="field.id">{{ field.label }}</mat-option>
                    }
                  </mat-select>
                </mat-form-field>

                <button
                  mat-icon-button
                  (click)="removeAction(i, a_idx)"
                  matTooltip="Remove action"
                >
                  <mat-icon>remove_circle_outline</mat-icon>
                </button>
              </div>
            }
          </div>
        </mat-card-content>
      </mat-card>
    }
    <button
      type="button"
      mat-raised-button
      color="accent"
      (click)="addRule()"
      class="add-rule-button"
    >
      <mat-icon>add</mat-icon>
      Add New Rule
    </button>
  </div>
</div>
