<div [formGroup]="parentForm()">
  <div formArrayName="rules" class="rules-main-container">

    @for (ruleGroup of rulesFormArray().controls; let i = $index; track i) {
      <div class="rule-card" [formGroupName]="i">
        <div class="rule-header">
          <h5>Rule #{{ i + 1 }}</h5>
          <button type="button" class="icon-button" (click)="removeRule(i)" title="Remove Rule">âœ•</button>
        </div>

        <div class="conditions-section" formArrayName="conditions">
          <div class="section-header">
            <h6>IF...</h6>
            <button type="button" (click)="addCondition(i)" title="Add Condition">+ AND</button>
          </div>
          @for (conditionGroup of $any(ruleGroup.get('conditions')).controls; let c_idx = $index; track c_idx) {
            <div class="condition-row" [formGroupName]="c_idx">
              <select formControlName="fieldId" class="form-select">
                <option value="" disabled>Select Field</option>
                @for (field of allFormFields(); track field.id) {
                  <option [value]="field.id">{{ field.label }}</option>
                }
              </select>

              <select formControlName="operator" class="form-select">
                @for (op of conditionOperators; track op) {
                  <option [value]="op">{{ op }}</option>
                }
              </select>

              <input formControlName="value" placeholder="Value" class="form-input" />
              <button type="button" class="icon-button" (click)="removeCondition(i, c_idx)" title="Remove Condition">-
              </button>
            </div>
          }
        </div>

        <div class="actions-section" formArrayName="actions">
          <div class="section-header">
            <h6>THEN...</h6>
            <button type="button" (click)="addAction(i)" title="Add Action">+ Action</button>
          </div>
          @for (actionGroup of $any(ruleGroup.get('actions')).controls; let a_idx = $index; track a_idx) {
            <div class="action-row" [formGroupName]="a_idx">
              <select formControlName="type" class="form-select">
                @for (action of actionTypes; track action) {
                  <option [value]="action">{{ action }}</option>
                }
              </select>

              <span>field:</span>
              <select formControlName="targetFieldId" class="form-select">
                <option value="" disabled>Select Target</option>
                @for (field of allFormFields(); track field.id) {
                  <option [value]="field.id">{{ field.label }}</option>
                }
              </select>
              <button type="button" class="icon-button" (click)="removeAction(i, a_idx)" title="Remove Action">-
              </button>
            </div>
          }
        </div>

      </div>
    }
    <button type="button" class="add-rule-btn" (click)="addRule()">Add Rule</button>
  </div>
</div>
